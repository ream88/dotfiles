# ============================================================================
# Environment Variables
# ============================================================================

# Paths - automatically deduplicate with typeset -U
typeset -U path
path=(
    /opt/homebrew/bin
    $HOME/.bin
    $HOME/.cargo/bin
    $HOME/.bun/bin
    /Applications/Postgres.app/Contents/Versions/17/bin
    $path
)

export HOMEBREW_CASK_OPTS="--appdir=/Applications"
export EDITOR=code
export GPG_TTY=$(tty)
export BUN_INSTALL="$HOME/.bun"

# Elixir configuration
export ERL_AFLAGS="-kernel shell_history enabled"
export MIX_OS_DEPS_COMPILE_PARTITION_COUNT=$(($(sysctl -n hw.physicalcpu) / 2))

# ============================================================================
# Oh-My-Zsh Configuration
# ============================================================================

ZSH=$HOME/.oh-my-zsh
ZSH_THEME="ream88"

# Oh-My-Zsh settings
DISABLE_AUTO_UPDATE="true"
DISABLE_AUTO_TITLE="true"
COMPLETION_WAITING_DOTS="true"

# Which plugins would you like to load? (plugins can be found in ~/.oh-my-zsh/plugins/*)
plugins=(
    asdf
    brew
    docker
    docker-compose
    git
    macos
    mix
    npm
)

source $ZSH/oh-my-zsh.sh

# ============================================================================
# Shell Options & History
# ============================================================================

# History configuration
HISTSIZE=50000
SAVEHIST=50000
HISTFILE=~/.zsh_history
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_SAVE_NO_DUPS
setopt SHARE_HISTORY

# Don't correct arguments
unsetopt correct_all
setopt correct
setopt extended_glob

# Disable bracketed mode (e.g., content pasted twice into the terminal).
unset zle_bracketed_paste

# Autocomplete path, so `cd rails` jumpts to `~/Code/Other/rails`
cdpath=(. ~ ~/Code/ ~/Code/*)

# ============================================================================
# Completions
# ============================================================================

# Docker CLI completions
fpath=(/Users/mario/.docker/completions $fpath)

# Bun completions
[ -s "/Users/mario/.bun/_bun" ] && source "/Users/mario/.bun/_bun"

# ============================================================================
# Aliases & Custom Functions
# ============================================================================

[[ -f $HOME/.zsh/aliases.sh ]] && source $HOME/.zsh/aliases.sh

# ============================================================================
# Tool Configurations
# ============================================================================

# McFly configuration
export MCFLY_DELETE_WITHOUT_CONFIRM=true
export MCFLY_FUZZY=2

# Fix problems with claude
if [ -n "$SSH_CONNECTION" ] && [ -z "$KEYCHAIN_UNLOCKED" ]; then
  security unlock-keychain ~/Library/Keychains/login.keychain-db
  export KEYCHAIN_UNLOCKED=true
fi

# ============================================================================
# External Tool Initialization (loaded last for performance)
# ============================================================================

# https://github.com/nvbn/thefuck
command -v thefuck >/dev/null && eval "$(thefuck --alias)"

# McFly
command -v mcfly >/dev/null && eval "$(mcfly init zsh)"

# # Wildcard search (disabled in favor of McFly)
# bindkey '^R' history-incremental-pattern-search-backward
# bindkey '^S' history-incremental-pattern-search-forward
